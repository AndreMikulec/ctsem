
#' ctStanPredictions
#'
#' Plots predictions of manifest variables for specific subjects from data fit with \code{\link{ctStanFit}}.
#' 
#' @param ctstanmodelobj model object as generated by \code{\link{ctModel}} using one of the Stan type arguments.
#' @param ctstanfitobj fit object as generated by \code{\link{ctStanFit}}.
#' @param datalong long format data object containing as used by \code{\link{ctStanFit}}.
#' @param subjects vector of integers denoting which subjects (from 1 to N) to plot predictions for. 
#' @param wait If true, user is prompted to continue before plotting next graph.  If false, graphs are plotted one after another without waiting.
#' @export

ctStanPredictions<-function(ctstanmodelobj,ctstanfitobj, datalong, subjects=1,wait=FALSE){
  
  f<-ctstanfitobj
  # s<-extract(ctstanfitobj)
  m<-ctstanmodelobj
  par<-m$parameters
  sum<-getMethod('summary','stanfit')(f)
  
  out<-list()
  
  for(subjecti in subjects){
  
  DRIFT<-matrix(NA,nrow=m$n.latent,ncol=m$n.latent)
  T0VAR<-matrix(NA,nrow=m$n.latent,ncol=m$n.latent)
  DIFFUSION<-matrix(NA,nrow=m$n.latent,ncol=m$n.latent)
  CINT<-matrix(NA,nrow=m$n.latent,ncol=1)
  T0MEANS<-matrix(NA,nrow=m$n.latent,ncol=1)
  if(m$n.TDpred > 0) TDPREDEFFECT<-matrix(NA,nrow=m$n.latent,ncol=m$n.TDpred)
  MANIFESTMEANS <- matrix(NA,nrow=m$n.manifest,ncol=1)
  MANIFESTVAR <- matrix(NA,nrow=m$n.manifest,ncol=m$n.manifest)
  LAMBDA <- matrix(NA,nrow=m$n.manifest,ncol=m$n.latent)
  
  for(rowi in 1:nrow(par)){

     eval(parse(text=paste0(par$matrix[rowi],'[',par$row[rowi],',',par$col[rowi],'] <- ',
       if(!is.na(par$value[rowi])) par$value[rowi],
       if(is.na(par$value[rowi])) sum$summary[which(rownames(sum$summary) %in% 
           paste0(par$matrix[rowi],'[',ifelse(par$indvarying[rowi],subjecti,1),',',par$row[rowi],
             if(!(par$matrix[rowi] %in% c('T0MEANS','MANIFESTMEANS','CINT'))) paste0(',',par$col[rowi]),
               ']')
         ),'mean'])))
  }
  DIFFUSION[upper.tri(DIFFUSION)] <- (t(DIFFUSION))[upper.tri(DIFFUSION)]
  T0VAR[upper.tri(T0VAR)] <- (t(T0VAR))[upper.tri(T0VAR)]
  MANIFESTVAR[upper.tri(MANIFESTVAR)] <- (t(MANIFESTVAR))[upper.tri(MANIFESTVAR)]
  
  model<-list(DRIFT=DRIFT,T0VAR=T0VAR,DIFFUSION=DIFFUSION,CINT=CINT,T0MEANS=T0MEANS,
    if(m$n.TDpred > 1) TDPREDEFFECT=TDPREDEFFECT,MANIFESTMEANS=MANIFESTMEANS,MANIFESTVAR=MANIFESTVAR,
    LAMBDA=LAMBDA)
  
  out[[subjecti]]<-ctKalman(ctstanmodelobj=ctstanmodelobj,kalmanpars=model,datalong=datalong,subject=subjecti)

  
}
  return(out)
}

